<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기업 재생에너지 지원센터 관리자</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/common.css">
</head>
<body>

<div class="wrapper">
    <aside th:replace="~{fragments/sidebar :: sidebar('admin')}"></aside>

    <div class="main-panel">
        <header th:replace="~{fragments/header :: header}"></header>

        <div class="content">
            <h2 class="page-title">관리자권한</h2>

            <form>
                <div class="form-table">
                    <div class="form-row">
                        <div class="label-col"><span class="required">*</span> 아이디</div>
                        <div class="input-col">
                            <input type="text" id="userId" style="width: 150px;">
                            <button type="button" id="checkIdBtn" class="btn-gray">중복확인</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="label-col"><span class="required">*</span> 비밀번호</div>
                        <div class="input-col">
                            <input type="password" id="password">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="label-col"><span class="required">*</span> 비밀번호 재입력</div>
                        <div class="input-col">
                            <input type="password" id="passwordConfirm">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="half-row">
                            <div class="half-item">
                                <div class="label-col"><span class="required">*</span> 성명</div>
                                <div class="input-col"><input type="text" id="name" style="width: 100%;"></div>
                            </div>
                            <div class="half-item">
                                <div class="label-col"><span class="required">*</span> 이메일</div>
                                <div class="input-col"><input type="text" id="email" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="half-row">
                            <div class="half-item">
                                <div class="label-col">부서</div>
                                <div class="input-col"><input type="text" id="department" style="width: 100%;"></div>
                            </div>
                            <div class="half-item">
                                <div class="label-col">전화번호</div>
                                <div class="input-col" style="gap: 5px;">
                                    <select id="phone1" style="height: 30px; border: 1px solid #ddd; width: 60px;">
                                        <option value="010">010</option>
                                        <option value="011">011</option>
                                        <option value="02">02</option>
                                        <option value="031">031</option>
                                        <option value="032">032</option>
                                        <option value="051">051</option>
                                        <option value="053">053</option>
                                        <option value="062">062</option>
                                    </select>
                                    -
                                    <input type="text" id="phone2" style="width: 70px; text-align: center;" maxlength="4">
                                    -
                                    <input type="text" id="phone3" style="width: 70px; text-align: center;" maxlength="4">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="label-col"><span class="required">*</span> 관리자권한</div>
                        <div class="input-col radio-group">
                            <label><input type="radio" name="auth" value="1"> 슈퍼관리자</label>
                            <label><input type="radio" name="auth" value="2" checked> 일반관리자</label>
                        </div>
                    </div>
                </div>

                <div class="helper-text">
                    - 권한구분이 '슈퍼관리자'인 경우 관리자 등록 및 가입 승인<br>
                    - 권한구분이 '일반관리자'인 경우 가입 승인
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn-submit">등록</button>
                    <button type="button" class="btn-cancel" onclick="location.href='/memberlist'"> 취소</button>
                </div>
            </form>
        </div>
    </div>
</div>

</body>
<script>
    // 1. 중복 확인 여부를 저장할 변수 (false: 확인 안됨, true: 사용 가능)
    let isIdChecked = false;

    // [보안관] 페이지 열리자마자 로그인 체크
    fetch('/api/check-login')
        .then(response => {
            if (response.status === 401) {
                location.href = '/adminlogin';
            }
            return response.json();
        })
        .then(data => {
            sessionStorage.setItem('loginStatus', 'active');
            if (data && data.auth === '2') {
                alert("권한이 없습니다.");
                location.href = '/memberlist';
            }
        })
        .catch(err => console.error(err));

    // ---------------------------------------------------------
    // [추가] 2. 아이디 입력값이 변경되면 중복확인 상태 초기화
    // ---------------------------------------------------------
    document.getElementById('userId').addEventListener('input', function() {
        isIdChecked = false;
    });

    // ---------------------------------------------------------
    // [추가] 3. 중복 확인 버튼 클릭 이벤트
    // ---------------------------------------------------------
    document.getElementById('checkIdBtn').addEventListener('click', function() {
        const userId = document.getElementById('userId').value.trim();

        if (!userId) {
            alert("아이디를 입력해주세요.");
            return;
        }

        // 서버로 중복 확인 요청 (GET 방식 예시)
        fetch(`/api/admins/check-id?userId=${userId}`)
            .then(response => response.json()) // true(중복) 또는 false(사용가능) 반환 가정
            .then(isDuplicate => {
                if (isDuplicate) {
                    alert("이미 사용 중인 아이디입니다.");
                    document.getElementById('userId').value = ""; // 입력창 비우기
                    document.getElementById('userId').focus();
                    isIdChecked = false;
                } else {
                    alert("사용 가능한 아이디입니다.");
                    isIdChecked = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("중복 확인 중 오류가 발생했습니다.");
            });
    });

    // 4. 등록 버튼 이벤트
    document.querySelector('.btn-submit').addEventListener('click', function(e) {
        e.preventDefault();

        // [추가] 중복 확인을 했는지 검사
        if (!isIdChecked) {
            alert("아이디 중복 확인을 해주세요.");
            return;
        }

        const pw = document.getElementById('password').value;
        const pwConfirm = document.getElementById('passwordConfirm').value;

        if(!pw) {
            alert("비밀번호를 입력해주세요.");
            return;
        }

        if(pw !== pwConfirm) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
        }

        const authNode = document.querySelector('input[name="auth"]:checked');
        const authValue = authNode ? authNode.value : "2";

        const p1 = document.getElementById('phone1').value;
        const p2 = document.getElementById('phone2').value;
        const p3 = document.getElementById('phone3').value;

        let fullPhone = "";
        if(p2 && p3) {
            fullPhone = `${p1}-${p2}-${p3}`;
        }

        const data = {
            userId: document.getElementById('userId').value,
            password: pw,
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            department: document.getElementById('department').value,
            phone: fullPhone,
            auth: authValue
        };

        if(!data.userId || !data.name || !data.email) {
            alert("필수 항목을 모두 입력해주세요.");
            return;
        }

        fetch('/api/admins', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
            .then(response => {
                if (response.ok) {
                    alert('등록되었습니다.');
                    location.href = '/memberlist';
                } else {
                    // 서버에서 에러 메시지를 줄 경우 처리
                    response.text().then(text => alert('등록 실패: ' + text));
                }
            })
            .catch(error => console.error('Error:', error));
    });
</script>
</html>