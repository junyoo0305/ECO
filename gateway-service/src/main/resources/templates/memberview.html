<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 상세/수정</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/common.css">
</head>
<body>

<div class="wrapper">
    <aside th:replace="~{fragments/sidebar :: sidebar('admin')}"></aside>

    <div class="main-panel">
        <header th:replace="~{fragments/header :: header}"></header>

        <div class="content">
            <h2 class="page-title">관리자관리</h2>

            <form>
                <div class="form-table">
                    <div class="form-row">
                        <div class="label-col">아이디</div>
                        <div class="input-col">
                            <input type="text" id="userId" style="width: 150px; background-color: #eee;" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="label-col"><span class="required">*</span> 비밀번호</div>
                        <div class="input-col">
                            <input type="password" id="password" placeholder="변경시에만 입력">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="label-col"><span class="required">*</span> 비밀번호 재입력</div>
                        <div class="input-col">
                            <input type="password" id="passwordConfirm">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="half-row">
                            <div class="half-item">
                                <div class="label-col"><span class="required">*</span> 성명</div>
                                <div class="input-col"><input type="text" id="name" style="width: 100%;"></div>
                            </div>
                            <div class="half-item">
                                <div class="label-col"><span class="required">*</span> 이메일</div>
                                <div class="input-col"><input type="text" id="email" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="half-row">
                            <div class="half-item">
                                <div class="label-col">부서</div>
                                <div class="input-col"><input type="text" id="department" style="width: 100%;"></div>
                            </div>
                            <div class="half-item">
                                <div class="label-col">전화번호</div>
                                <div class="input-col" style="gap: 5px;">
                                    <select id="phone1" style="height: 30px; border: 1px solid #ddd; width: 60px;">
                                        <option value="010">010</option>
                                        <option value="011">011</option>
                                        <option value="02">02</option>
                                        <option value="031">031</option>
                                        <option value="032">032</option>
                                        <option value="051">051</option>
                                        <option value="053">053</option>
                                        <option value="062">062</option>
                                    </select>
                                    -
                                    <input type="text" id="phone2" style="width: 70px; text-align: center;" maxlength="4">
                                    -
                                    <input type="text" id="phone3" style="width: 70px; text-align: center;" maxlength="4">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="label-col"><span class="required">*</span> 권한구분</div>
                        <div class="input-col radio-group">
                            <label><input type="radio" name="auth" value="1"> 슈퍼관리자</label>
                            <label><input type="radio" name="auth" value="2"> 일반관리자</label>
                        </div>
                    </div>
                </div>

                <div class="helper-text">
                    - 권한구분이 '슈퍼관리자'인 경우 관리자 등록 및 가입 승인<br>
                    - 권한구분이 '일반관리자'인 경우 가입 승인
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn-list" onclick="location.href='/memberlist'">목록</button>
                    <button type="button" class="btn-update">수정</button>
                    <button type="button" class="btn-delete">삭제</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>

    // [보안관] 페이지 열리자마자 로그인 체크
    fetch('/api/check-login')
        .then(response => {
            if (response.status === 401) {
                // 1. 로그인이 풀렸는데, '로그인 했었던 흔적(active)'이 남아있다면? -> 세션 만료!
                if (sessionStorage.getItem('loginStatus') === 'active') {
                    alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                    sessionStorage.removeItem('loginStatus'); // 알림 띄웠으니 흔적 지움
                }
                // 2. 흔적이 없으면(처음 접속) 그냥 조용히 로그인 페이지로
                location.href = '/adminlogin';
            } else if (response.ok) {
                // 3. 현재 로그인 상태라면 '로그인 중'이라는 흔적을 남김
                sessionStorage.setItem('loginStatus', 'active');
            }
        })
        .catch(err => console.error(err));

    // URL에서 seq 파라미터 가져오기
    const urlParams = new URLSearchParams(window.location.search);
    const seq = urlParams.get('seq');

    // 1. 페이지 로드 시 데이터 조회 및 바인딩
    document.addEventListener('DOMContentLoaded', function() {
        if (!seq) {
            alert("잘못된 접근입니다.");
            location.href = '/memberlist';
            return;
        }

        fetch(`/api/admins/${seq}`)
            .then(response => {
                if(!response.ok) throw new Error('Data fetch failed');
                return response.json();
            })
            .then(data => {
                // 데이터 바인딩
                document.getElementById('userId').value = data.userId;
                document.getElementById('name').value = data.name;
                document.getElementById('email').value = data.email;
                document.getElementById('department').value = data.department || "";
                if (data.phone) {
                    const parts = data.phone.split('-'); // '-' 기준으로 자름
                    if (parts.length === 3) {
                        document.getElementById('phone1').value = parts[0];
                        document.getElementById('phone2').value = parts[1];
                        document.getElementById('phone3').value = parts[2];
                    } else {
                        // 하이픈 형식이 아닐 경우 그냥 중간 칸에 다 넣거나 처리 (예외처리)
                        document.getElementById('phone2').value = data.phone;
                    }
                }

                // 비밀번호는 보안상 불러오지 않음 (공란)

                // 라디오 버튼 체크
                const radio = document.querySelector(`input[name="auth"][value="${data.auth}"]`);
                if(radio) radio.checked = true;
            })
            .catch(error => {
                console.error(error);
                alert("데이터를 불러오는데 실패했습니다.");
            });
    });

    // 2. 수정 버튼 클릭 이벤트
    document.querySelector('.btn-update').addEventListener('click', function() {
        const pw = document.getElementById('password').value;
        const pwConfirm = document.getElementById('passwordConfirm').value;

        // 비밀번호 확인
        if(pw && pw !== pwConfirm) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
        }

        const authNode = document.querySelector('input[name="auth"]:checked');

        // [추가] 전화번호 합치기 로직
        const p1 = document.getElementById('phone1').value;
        const p2 = document.getElementById('phone2').value;
        const p3 = document.getElementById('phone3').value;
        let fullPhone = "";
        if(p2 && p3) {
            fullPhone = `${p1}-${p2}-${p3}`;
        }

        const data = {
            userId: document.getElementById('userId').value,
            password: pw,
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            department: document.getElementById('department').value,
            phone: fullPhone, // [수정] 합쳐진 번호 전송
            auth: authNode ? authNode.value : "2"
        };

        fetch(`/api/admins/${seq}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => {
                if(response.ok) {
                    alert('수정되었습니다.');
                    location.href = '/memberlist';
                } else {
                    alert('수정 실패');
                }
            });
    });

    // 3. 삭제 버튼 클릭 이벤트
    document.querySelector('.btn-delete').addEventListener('click', function() {
        if(!confirm('정말로 삭제하시겠습니까?')) return;

        fetch(`/api/admins/${seq}`, {
            method: 'DELETE'
        })
            .then(response => {
                if(response.ok) {
                    alert('삭제되었습니다.');
                    location.href = '/memberlist';
                } else {
                    alert('삭제 실패');
                }
            });
    });


</script>
</body>
</html>