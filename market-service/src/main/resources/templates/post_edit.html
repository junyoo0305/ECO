<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë§¤ë¬¼ ìˆ˜ì • - ëŒ€í•­ì—ë„ˆì§€</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        /* post_write.htmlê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼ ì ìš© */
        .section-title { font-size: 1.1rem; font-weight: bold; margin: 30px 0 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; color: #333; }
        .form-row { display: flex; margin-bottom: 20px; align-items: flex-start; }
        .form-label { width: 180px; font-weight: bold; color: #444; padding-top: 10px; flex-shrink: 0; position: relative; }
        .form-input-box { flex: 1; }

        .radio-group { display: flex; gap: 20px; flex-wrap: wrap; padding-top: 10px; }
        .radio-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .radio-group input[type="radio"], .radio-group input[type="checkbox"] { transform: scale(1.2); accent-color: #2fb44a; }

        .input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .form-input:focus { border-color: #2fb44a; outline: none; }

        /* ì½ê¸° ì „ìš© ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ (íšŒìƒ‰ ë°°ê²½) */
        .form-input[readonly] { background-color: #f5f5f5; color: #888; cursor: default; }

        .unit-text { color: #666; font-weight: bold; min-width: 60px; }
        .helper-text { font-size: 0.85rem; color: #888; margin-top: 5px; }

        .btn-green { background-color: #2fb44a; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-green:hover { background-color: #26963d; }

        /* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .current-image-box { margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; border: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .current-image-box img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }

        /* íˆ´íŒ ìŠ¤íƒ€ì¼ */
        .tooltip-icon {
            display: inline-block; width: 18px; height: 18px; background: #eee; color: #666; border-radius: 50%;
            text-align: center; line-height: 18px; font-size: 12px; cursor: help; margin-left: 5px;
        }
        .tooltip-content {
            visibility: hidden; width: 320px; background-color: #f9f9f9; color: #333; text-align: left;
            border: 1px solid #ddd; padding: 10px; border-radius: 6px; position: absolute; z-index: 1;
            bottom: 120%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-weight: normal; font-size: 0.85rem; line-height: 1.4;
        }
        .tooltip-icon:hover .tooltip-content { visibility: visible; opacity: 1; }
        .tooltip-content::after {
            content: ""; position: absolute; top: 100%; left: 20px; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #ddd transparent transparent transparent;
        }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header('market')}"></div>

<div class="page-container">
    <div th:replace="~{fragments/sidebar_market :: sidebar('all')}"></div>

    <main class="main-content">
        <div class="header">
            <h1>ğŸ“ ë§¤ë¬¼ ì •ë³´ ìˆ˜ì •</h1>
            <p>ë“±ë¡ëœ ë°œì „ì†Œ ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.</p>
        </div>

        <div class="card">
            <form th:action="@{/market/edit/{id}(id=${post.id})}" method="post" enctype="multipart/form-data" onsubmit="prepareFormData()">

                <div class="section-title">ê¸°ë³¸ ì •ë³´</div>

                <div class="form-row">
                    <label class="form-label">ê²Œì‹œê¸€ ì œëª© <span style="color:red">*</span></label>
                    <div class="form-input-box">
                        <input type="text" name="title" class="form-input" required th:value="${post.title}">
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">ë°œì „ì› <span style="color:red">*</span></label>
                    <div class="form-input-box radio-group">
                        <label><input type="radio" name="energyType" value="íƒœì–‘ê´‘" th:checked="${post.energyType == 'íƒœì–‘ê´‘'}"> íƒœì–‘ê´‘</label>
                        <label><input type="radio" name="energyType" value="í’ë ¥" th:checked="${post.energyType == 'í’ë ¥'}"> í’ë ¥</label>
                        <label><input type="radio" name="energyType" value="ìˆ˜ë ¥" th:checked="${post.energyType == 'ìˆ˜ë ¥'}"> ìˆ˜ë ¥</label>
                        <label><input type="radio" name="energyType" value="ë°”ì´ì˜¤" th:checked="${post.energyType == 'ë°”ì´ì˜¤'}"> ë°”ì´ì˜¤</label>
                        <label><input type="radio" name="energyType" value="í•´ì–‘" th:checked="${post.energyType == 'í•´ì–‘'}"> í•´ì–‘</label>
                        <label><input type="radio" name="energyType" value="ì§€ì—´" th:checked="${post.energyType == 'ì§€ì—´'}"> ì§€ì—´</label>
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">ëŒ€í‘œ ì´ë¯¸ì§€</label>
                    <div class="form-input-box">
                        <div th:if="${post.imageUrl != null}" class="current-image-box">
                            <img th:src="${post.imageUrl}" alt="í˜„ì¬ ì´ë¯¸ì§€">
                            <div>
                                <p style="font-weight: bold; margin-bottom: 5px;">í˜„ì¬ ë“±ë¡ëœ ì´ë¯¸ì§€</p>
                                <p style="font-size: 0.8rem; color: #666;">ìƒˆë¡œìš´ íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì´ ì‚¬ì§„ì€ ì‚­ì œë˜ê³  êµì²´ë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                        <input type="file" name="imageFile" class="form-input" accept="image/*">
                    </div>
                </div>

                <div class="section-title">ë¶€ì§€ ì •ë³´</div>

                <div class="form-row">
                    <label class="form-label">ìœ íœ´ ë¶€ì§€ ë©´ì </label>
                    <div class="form-input-box">
                        <div class="radio-group" style="margin-bottom: 10px; padding-top: 0;">
                            <label><input type="radio" name="landType" value="ì§€ë¶•" th:checked="${post.landType == 'ì§€ë¶•'}"> ì§€ë¶•</label>
                            <label><input type="radio" name="landType" value="ë‚˜ëŒ€ì§€" th:checked="${post.landType == 'ë‚˜ëŒ€ì§€'}"> ë‚˜ëŒ€ì§€</label>
                        </div>
                        <div class="input-group">
                            <input type="number" name="landArea" class="form-input" th:value="${post.landArea}">
                            <span class="unit-text">mÂ²</span>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">ìƒì‚° ì§€ì—­ <span style="color:red">*</span></label>
                    <div class="form-input-box">
                        <div class="input-group">
                            <input type="text" id="address" name="location" class="form-input"
                                   th:value="${post.location}" required readonly onclick="execDaumPostcode()"
                                   style="caret-color: transparent; cursor: pointer; background-color: #fff;">
                            <button type="button" onclick="execDaumPostcode()" class="btn-green">ì£¼ì†Œ ê²€ìƒ‰</button>
                        </div>
                        <input type="text" name="locationDetail" class="form-input" th:value="${post.locationDetail}">
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">ê³„ì•½ ê°€ëŠ¥ ë°œì „ì„¤ë¹„ ìš©ëŸ‰ <span style="color:red">*</span></label>
                    <div class="form-input-box input-group">
                        <input type="number" name="facilityCapacity" class="form-input" required th:value="${post.facilityCapacity}"
                               oninput="checkCapacity(this)">
                        <span class="unit-text">kW</span>
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">ê³„ì•½ ìœ í˜• <span style="color:red">*</span></label>
                    <div class="form-input-box radio-group">
                        <label><input type="checkbox" name="contractTypes" value="REC êµ¬ë§¤(í˜„ë¬¼ê³„ì•½)"
                                      th:checked="${post.contractType != null and #strings.contains(post.contractType, 'REC êµ¬ë§¤(í˜„ë¬¼ê³„ì•½)')}"> REC êµ¬ë§¤(í˜„ë¬¼ê³„ì•½)</label>
                        <label><input type="checkbox" name="contractTypes" value="REC êµ¬ë§¤(ê¸°ê°„ê³„ì•½)"
                                      th:checked="${post.contractType != null and #strings.contains(post.contractType, 'REC êµ¬ë§¤(ê¸°ê°„ê³„ì•½)')}"> REC êµ¬ë§¤(ê¸°ê°„ê³„ì•½)</label>
                        <label><input type="checkbox" name="contractTypes" value="ì œ3ì PPA"
                                      th:checked="${post.contractType != null and #strings.contains(post.contractType, 'ì œ3ì PPA')}"> ì œ3ì PPA</label>
                        <label><input type="checkbox" name="contractTypes" value="ì§ì ‘ PPA"
                                      th:checked="${post.contractType != null and #strings.contains(post.contractType, 'ì§ì ‘ PPA')}"> ì§ì ‘ PPA</label>
                        <label><input type="checkbox" name="contractTypes" value="VPPA(SMP+REC ê³ ì •ê°€ê²© ê³„ì•½)"
                                      th:checked="${post.contractType != null and #strings.contains(post.contractType, 'VPPA')}"> VPPA(SMP+REC ê³ ì •ê°€ê²© ê³„ì•½)</label>
                        <input type="hidden" name="contractType" id="contractTypeResult">
                    </div>
                </div>

                <div class="section-title">ê³„ì•½ ì •ë³´ (ìë™ ê³„ì‚°)</div>

                <div class="form-row">
                    <label class="form-label">ê³„ì•½ ë‹¨ìœ„ <span style="color:red">*</span></label>
                    <div class="form-input-box radio-group">
                        <label><input type="radio" name="contractUnit" value="kWh" onchange="toggleUnit()"
                                      th:checked="${post.contractUnit == 'kWh'}"> ë°œì „ëŸ‰(kWh)</label>
                        <label><input type="radio" name="contractUnit" value="REC" onchange="toggleUnit()"
                                      th:checked="${post.contractUnit == 'REC'}"> REC(ê°œ)</label>
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">ì „ë ¥ëŸ‰ <span style="color:red">*</span></label>
                    <div class="form-input-box" id="volume-box">
                        <div class="input-group" id="group-kwh">
                            <input type="number" id="inputKwh" name="volumeKwh" class="form-input"
                                   th:value="${post.volumeKwh}" placeholder="ì „ë ¥ëŸ‰ ì…ë ¥" oninput="calcVolume('kWh')">
                            <span class="unit-text">kWh</span>
                        </div>
                        <div class="input-group" id="group-rec">
                            <input type="number" id="inputRec" name="volumeRec" class="form-input"
                                   th:value="${post.volumeRec}" placeholder="(RECë¡œ ìë™ë³€í™˜)" readonly oninput="calcVolume('REC')">
                            <span class="unit-text">REC</span>
                        </div>
                        <p class="helper-text">* 1 REC = 1,000 kWh Ã— ê°€ì¤‘ì¹˜ (ì†Œìˆ˜ì  ì˜¬ë¦¼)</p>
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">ê³„ì•½ í¬ë§ êµ¬ë§¤ë‹¨ê°€ <span style="color:red">*</span></label>
                    <div class="form-input-box" id="price-box">
                        <div class="input-group" id="group-price-kwh">
                            <input type="number" id="priceKwh" name="priceKrw" class="form-input"
                                   th:value="${post.contractUnit == 'kWh' ? post.priceKrw : ''}"
                                   placeholder="ë‹¨ê°€ ì…ë ¥" oninput="calcPrice('kWh')">
                            <span class="unit-text">ì›/kWh</span>
                        </div>
                        <div class="input-group" id="group-price-rec">
                            <input type="number" id="priceRec" class="form-input"
                                   th:value="${post.contractUnit == 'REC' ? post.priceKrw : ''}"
                                   placeholder="(ìë™ ë³€í™˜ë¨)" readonly oninput="calcPrice('REC')">
                            <span class="unit-text">ì›/REC</span>
                        </div>
                        <div class="radio-group">
                            <label><input type="checkbox" name="isPriceNegotiable" th:checked="${post.isPriceNegotiable == 'Y'}"> í˜‘ì˜ ê°€ëŠ¥</label>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">
                        ê°€ì¤‘ì¹˜ <span style="font-size: 0.8rem; color: #888; font-weight: normal;">(ì„ íƒ í•­ëª©)</span>
                        <div class="tooltip-icon">?
                            <span class="tooltip-content">ê°€ì¤‘ì¹˜ì—ëŠ” 0 ë³´ë‹¤ í° ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•˜ë©°, ì†Œìˆ˜ì  ì…‹ì§¸ ìë¦¬ê¹Œì§€ ìœ íš¨í•©ë‹ˆë‹¤.</span>
                        </div>
                    </label>
                    <div class="form-input-box input-group">
                        <input type="number" step="0.001" id="weightingFactor" name="weightingFactor" class="form-input"
                               th:value="${post.weightingFactor}" oninput="checkWeight(this)">
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">í¬ë§ ê³„ì•½ ê¸°ê°„ <span style="color:red">*</span></label>
                    <div class="form-input-box">
                        <div class="input-group">
                            <span style="min-width: 60px;">ì‹œì‘ì¼</span>
                            <input type="date" name="contractStartDate" class="form-input" th:value="${post.contractStartDate}">
                        </div>
                        <div class="input-group">
                            <span style="min-width: 60px;">ì¢…ë£Œì¼</span>
                            <input type="date" name="contractEndDate" class="form-input" th:value="${post.contractEndDate}">
                        </div>
                        <div class="radio-group">
                            <label><input type="checkbox" name="isPeriodNegotiable" th:checked="${post.isPeriodNegotiable == 'Y'}"> í˜‘ì˜ ê°€ëŠ¥</label>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <label class="form-label">ìƒì„¸ ì„¤ëª…</label>
                    <div class="form-input-box">
                        <textarea name="content" class="form-input" rows="5" th:text="${post.content}"></textarea>
                    </div>
                </div>

                <div style="text-align: right; margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                    <a th:href="@{/seller/sellerpost}" style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 4px; color: #333; text-decoration: none; margin-right: 10px;">ì·¨ì†Œ</a>
                    <button type="submit" class="btn-green">ìˆ˜ì • ì™„ë£Œ</button>
                </div>
            </form>
        </div>
    </main>
</div>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                document.getElementById("address").value = addr;
            }
        }).open();
    }

    function prepareFormData() {
        const checkboxes = document.querySelectorAll('input[name="contractTypes"]:checked');
        const values = Array.from(checkboxes).map(cb => cb.value);
        document.getElementById('contractTypeResult').value = values.join(',');
    }

    // ==========================================
    //  ğŸ›¡ï¸ ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§
    // ==========================================

    function checkCapacity(el) {
        if (el.value.length > 9) {
            alert('ê³„ì•½ í¬ë§ ë°œì „ì„¤ë¹„ ìš©ëŸ‰ì€ 9ìë¦¬ ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            el.value = el.value.slice(0, 9);
        }
    }

    function checkWeight(el) {
        if (el.value.indexOf('.') !== -1) {
            var parts = el.value.split('.');
            if (parts[1].length > 3) {
                alert('ê°€ì¤‘ì¹˜ëŠ” ì†Œìˆ˜ì  ì…‹ì§¸ ìë¦¬ê¹Œì§€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                el.value = parseFloat(el.value).toFixed(3);
            }
        }
        reCalcAll(); // ê°’ ë³€ê²½ í›„ ì¬ê³„ì‚°
    }

    // ==========================================
    //  âš¡ ìë™ ê³„ì‚° ë° ìœ„ì¹˜ ë³€ê²½ ë¡œì§
    // ==========================================

    window.onload = function() {
        toggleUnit(); // ì½ê¸° ì „ìš© ëª¨ë“œ ë° ìœ„ì¹˜ ì„¤ì •
        reCalcAll();  // ì €ì¥ëœ ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ë¨¸ì§€ ë¹ˆì¹¸ ì±„ìš°ê¸°
    }

    function toggleUnit() {
        const unit = document.querySelector('input[name="contractUnit"]:checked').value;

        // ë°•ìŠ¤(ì»¨í…Œì´ë„ˆ)
        const volumeBox = document.getElementById('volume-box');
        const priceBox = document.getElementById('price-box');

        // ê·¸ë£¹(ì¤„)
        const groupKwh = document.getElementById('group-kwh');
        const groupRec = document.getElementById('group-rec');
        const groupPriceKwh = document.getElementById('group-price-kwh');
        const groupPriceRec = document.getElementById('group-price-rec');

        // ì…ë ¥ì°½
        const inputKwh = document.getElementById('inputKwh');
        const inputRec = document.getElementById('inputRec');
        const priceKwh = document.getElementById('priceKwh');
        const priceRec = document.getElementById('priceRec');

        if (unit === 'kWh') {
            // [ìœ„ì¹˜ ë³€ê²½] kWh ìœ„, REC ì•„ë˜
            volumeBox.insertBefore(groupKwh, groupRec);
            priceBox.insertBefore(groupPriceKwh, groupPriceRec);

            // [ìƒíƒœ ë³€ê²½]
            inputKwh.readOnly = false; inputKwh.required = true;
            inputRec.readOnly = true; inputRec.required = false;

            priceKwh.readOnly = false;
            priceRec.readOnly = true;
        } else {
            // [ìœ„ì¹˜ ë³€ê²½] REC ìœ„, kWh ì•„ë˜
            volumeBox.insertBefore(groupRec, groupKwh);
            priceBox.insertBefore(groupPriceRec, groupPriceKwh);

            // [ìƒíƒœ ë³€ê²½]
            inputKwh.readOnly = true; inputKwh.required = false;
            inputRec.readOnly = false; inputRec.required = true;

            priceKwh.readOnly = true;
            priceRec.readOnly = false;
        }
    }

    function calcVolume(source) {
        const weight = parseFloat(document.getElementById('weightingFactor').value) || 1.0;
        const kwhInput = document.getElementById('inputKwh');
        const recInput = document.getElementById('inputRec');

        if (source === 'kWh') {
            let kwh = parseFloat(kwhInput.value) || 0;
            if (kwh > 100000000) {
                alert('ì „ë ¥ëŸ‰ì€ 100,000,000 ì´ìƒ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                kwhInput.value = 100000000;
                kwh = 100000000;
            }
            const rec = (kwh / 1000) * weight;
            recInput.value = Math.floor(rec);
        } else {
            const rec = parseFloat(recInput.value) || 0;
            const kwh = (rec / weight) * 1000;
            if (kwh > 100000000) {
                alert('ì „ë ¥ëŸ‰(í™˜ì‚°ê°’)ì´ 100,000,000ì„ ì´ˆê³¼í•©ë‹ˆë‹¤.');
            }
            kwhInput.value = Math.round(kwh);
        }
    }

    function calcPrice(source) {
        const weight = parseFloat(document.getElementById('weightingFactor').value) || 1.0;
        const priceKwhInput = document.getElementById('priceKwh');
        const priceRecInput = document.getElementById('priceRec');

        if (source === 'kWh') {
            const pKwh = parseFloat(priceKwhInput.value) || 0;
            let pRec = (pKwh * 1000) / weight;
            pRec = Math.round(pRec);

            if (pRec > 999999) {
                alert('ì›/REC ë³€í™˜ê°’ì´ ìµœëŒ€ê°’(999,999ì›)ì„ ì´ˆê³¼í•©ë‹ˆë‹¤.');
                priceKwhInput.value = '';
                priceRecInput.value = '';
                return;
            }
            priceRecInput.value = pRec;
        } else {
            let pRec = parseFloat(priceRecInput.value) || 0;
            if (pRec > 999999) {
                alert('ì›/RECëŠ” ìµœëŒ€ê°’ 999,999ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                priceRecInput.value = 999999;
                pRec = 999999;
            }
            const pKwh = (pRec * weight) / 1000;
            priceKwhInput.value = Math.round(pKwh);
        }
    }

    function reCalcAll() {
        const unit = document.querySelector('input[name="contractUnit"]:checked').value;
        calcVolume(unit);
        calcPrice(unit);
    }
</script>

</body>
</html>