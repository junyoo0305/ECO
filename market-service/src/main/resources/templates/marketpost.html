<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì „ì²´ ë§¤ë¬¼ ì¥í„° - ëŒ€í•­ì—ë„ˆì§€</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ ... */
        .list-header-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .total-count { font-size: 1.1rem; color: #333; }
        .total-count b { color: #2fb44a; }
        .sort-tabs { display: flex; gap: 5px; }
        .sort-btn { padding: 6px 14px; border: 1px solid #ddd; border-radius: 20px; background: white; color: #666; font-size: 0.9rem; text-decoration: none; transition: all 0.2s; cursor: pointer; }
        .sort-btn:hover { background: #f8f9fa; color: #333; }
        .sort-btn.active { background: #333; color: white; border-color: #333; font-weight: bold; }
        .market-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .market-table th { padding: 15px 0; border-bottom: 1px solid #ccc; font-size: 0.95rem; color: #666; font-weight: bold; background: #fbfbfb; text-align: center; }
        .market-table td { padding: 20px 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .market-table tr:hover { background-color: #f8f9fa; cursor: pointer; }
        .col-no { width: 60px; text-align: center; color: #666; }
        .col-title { text-align: left; }
        .col-volume { width: 150px; text-align: right; font-weight: bold; color: #333; padding-right: 30px !important; }
        .col-price { width: 180px; text-align: right; font-weight: bold; color: #333; padding-right: 20px !important; }
        .title-top { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .region-text { font-weight: bold; color: #333; font-size: 1.1rem; }
        .title-text { font-weight: bold; color: #333; font-size: 1.1rem; }
        .badge-row { display: flex; gap: 5px; margin-top: 5px; }
        .badge-energy { background: #fff3e0; color: #f57c00; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .badge-contract { background: #f1f3f5; color: #495057; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; border: 1px solid #e9ecef; }
        .badge-status-end { background: #fff5f5; color: #e03131; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 40px; }
        .page-link { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border: 1px solid #ddd; border-radius: 4px; color: #555; text-decoration: none; font-size: 0.9rem; background: white; transition: all 0.2s; }
        .page-link:hover { background-color: #f1f3f5; border-color: #ccc; }
        .page-link.active { background-color: #2fb44a; color: white; border-color: #2fb44a; font-weight: bold; }
        .page-link.disabled { color: #ccc; pointer-events: none; border-color: #eee; }

        /* â–¼â–¼â–¼ [ì¶”ê°€] ì¡°ê±´ ê²€ìƒ‰ í•„í„° ìŠ¤íƒ€ì¼ (ì´ë¯¸ì§€ ì°¸ê³ ) â–¼â–¼â–¼ */
        .filter-toggle-btn {
            background: white; border: 1px solid #2fb44a; color: #2fb44a; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .filter-toggle-btn:hover { background: #ebfbee; }

        .filter-box {
            background: white; border: 1px solid #ddd; border-radius: 8px; padding: 25px; margin-bottom: 30px; display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .filter-row { display: flex; margin-bottom: 15px; border-bottom: 1px solid #f1f3f5; padding-bottom: 15px; }
        .filter-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .filter-label { width: 140px; font-weight: bold; color: #444; flex-shrink: 0; padding-top: 2px; }
        .filter-content { flex: 1; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }

        .checkbox-label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 0.95rem; color: #555; }
        .checkbox-label input { accent-color: #2fb44a; transform: scale(1.1); }

        .price-input { width: 120px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; text-align: right; }
        .filter-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn-reset { background: white; border: 1px solid #ddd; padding: 8px 16px; border-radius: 4px; color: #666; cursor: pointer; }
        .btn-apply { background: #2fb44a; border: 1px solid #2fb44a; padding: 8px 20px; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: header('marketpost')}"></div>

<div class="page-container">
    <div th:replace="~{fragments/sidebar_market :: sidebar('all')}"></div>

    <main class="main-content">
        <div class="header">
            <h1>ğŸ›’ ì—ë„ˆì§€ ê±°ë˜ì†Œ</h1>
            <p>ì „êµ­ì˜ ë‹¤ì–‘í•œ ì‹ ì¬ìƒ ì—ë„ˆì§€ ë§¤ë¬¼ì„ í™•ì¸í•´ë³´ì„¸ìš”.</p>
        </div>

        <form id="searchForm" th:action="@{/market/marketpost}" method="get">
            <input type="hidden" name="sort" th:value="${sort}">
            <input type="hidden" name="page" value="0" id="pageInput">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <button type="button" class="filter-toggle-btn" onclick="toggleFilter()">
                    âš¡ ì¡°ê±´ ê²€ìƒ‰ <span id="toggleIcon">â–¼</span>
                </button>
                <a th:href="@{/market/write}" class="btn-primary" style="text-decoration: none; padding: 8px 16px; font-size: 0.9rem;">
                    ğŸ“¢ ë§¤ë¬¼ ë“±ë¡
                </a>
            </div>

            <div id="filterBox" class="filter-box">
                <div class="filter-row">
                    <div class="filter-label">ê³„ì•½ ìœ í˜•</div>
                    <div class="filter-content">
                        <label class="checkbox-label"><input type="checkbox" name="contractTypes" value="REC êµ¬ë§¤(í˜„ë¬¼ê³„ì•½)" th:checked="${searchDto.contractTypes != null and #lists.contains(searchDto.contractTypes, 'REC êµ¬ë§¤(í˜„ë¬¼ê³„ì•½)')}"> REC êµ¬ë§¤(í˜„ë¬¼ê³„ì•½)</label>
                        <label class="checkbox-label"><input type="checkbox" name="contractTypes" value="REC êµ¬ë§¤(ê¸°ê°„ê³„ì•½)" th:checked="${searchDto.contractTypes != null and #lists.contains(searchDto.contractTypes, 'REC êµ¬ë§¤(ê¸°ê°„ê³„ì•½)')}"> REC êµ¬ë§¤(ê¸°ê°„ê³„ì•½)</label>
                        <label class="checkbox-label"><input type="checkbox" name="contractTypes" value="ì§ì ‘ PPA" th:checked="${searchDto.contractTypes != null and #lists.contains(searchDto.contractTypes, 'ì§ì ‘ PPA')}"> ì§ì ‘ PPA</label>
                        <label class="checkbox-label"><input type="checkbox" name="contractTypes" value="ì œ3ì PPA" th:checked="${searchDto.contractTypes != null and #lists.contains(searchDto.contractTypes, 'ì œ3ì PPA')}"> ì œ3ì PPA</label>
                        <label class="checkbox-label"><input type="checkbox" name="contractTypes" value="VPPA" th:checked="${searchDto.contractTypes != null and #lists.contains(searchDto.contractTypes, 'VPPA')}"> VPPA</label>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-label">ë°œì „ì›</div>
                    <div class="filter-content">
                        <label class="checkbox-label"><input type="checkbox" name="energyTypes" value="íƒœì–‘ê´‘" th:checked="${searchDto.energyTypes != null and #lists.contains(searchDto.energyTypes, 'íƒœì–‘ê´‘')}"> íƒœì–‘ê´‘</label>
                        <label class="checkbox-label"><input type="checkbox" name="energyTypes" value="í’ë ¥" th:checked="${searchDto.energyTypes != null and #lists.contains(searchDto.energyTypes, 'í’ë ¥')}"> í’ë ¥</label>
                        <label class="checkbox-label"><input type="checkbox" name="energyTypes" value="ìˆ˜ë ¥" th:checked="${searchDto.energyTypes != null and #lists.contains(searchDto.energyTypes, 'ìˆ˜ë ¥')}"> ìˆ˜ë ¥</label>
                        <label class="checkbox-label"><input type="checkbox" name="energyTypes" value="ë°”ì´ì˜¤" th:checked="${searchDto.energyTypes != null and #lists.contains(searchDto.energyTypes, 'ë°”ì´ì˜¤')}"> ë°”ì´ì˜¤</label>
                        <label class="checkbox-label"><input type="checkbox" name="energyTypes" value="í•´ì–‘" th:checked="${searchDto.energyTypes != null and #lists.contains(searchDto.energyTypes, 'í•´ì–‘')}"> í•´ì–‘</label>
                        <label class="checkbox-label"><input type="checkbox" name="energyTypes" value="ì§€ì—´" th:checked="${searchDto.energyTypes != null and #lists.contains(searchDto.energyTypes, 'ì§€ì—´')}"> ì§€ì—´</label>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-label">ìƒì‚° ì§€ì—­</div>
                    <div class="filter-content" style="gap: 10px;">
                        <th:block th:each="region : ${ {'ì„œìš¸','ê²½ê¸°','ë¶€ì‚°','ëŒ€êµ¬','ì¸ì²œ','ê´‘ì£¼','ëŒ€ì „','ìš¸ì‚°','ì„¸ì¢…','ê°•ì›','ì¶©ë¶','ì¶©ë‚¨','ì „ë¶','ì „ë‚¨','ê²½ë¶','ê²½ë‚¨','ì œì£¼'} }">
                            <label class="checkbox-label" style="min-width: 50px;">
                                <input type="checkbox" name="regions" th:value="${region}" th:checked="${searchDto.regions != null and #lists.contains(searchDto.regions, region)}"> [[${region}]]
                            </label>
                        </th:block>
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-label">ê³„ì•½ í¬ë§ íŒë§¤ë‹¨ê°€</div>
                    <div class="filter-content">
                        <input type="number" name="minPrice" class="price-input" placeholder="ìµœì†Œ" th:value="${searchDto.minPrice}"> ì›
                        <span>~</span>
                        <input type="number" name="maxPrice" class="price-input" placeholder="ìµœëŒ€" th:value="${searchDto.maxPrice}"> ì›

                        <label class="checkbox-label" style="margin-left: 20px;">
                            <input type="checkbox" name="isNego" value="true" th:checked="${searchDto.isNego}"> í˜‘ì˜ ê°€ëŠ¥í•œ ë§¤ë¬¼ë§Œ ë³´ê¸°
                        </label>
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="button" class="btn-reset" onclick="resetFilter()">í•„í„° ì´ˆê¸°í™” â†º</button>
                    <button type="submit" class="btn-apply">í•„í„° ì ìš©</button>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px;">
                <div class="sort-tabs">
                    <button type="button" onclick="submitSort('latest')" class="sort-btn" th:classappend="${sort == 'latest'} ? 'active'">ìµœì‹  ë“±ë¡ìˆœ</button>
                    <button type="button" onclick="submitSort('volume')" class="sort-btn" th:classappend="${sort == 'volume'} ? 'active'">ì „ë ¥ëŸ‰ ë§ì€ìˆœ</button>
                    <button type="button" onclick="submitSort('priceHigh')" class="sort-btn" th:classappend="${sort == 'priceHigh'} ? 'active'">ë‹¨ê°€ ë†’ì€ìˆœ</button>
                    <button type="button" onclick="submitSort('priceLow')" class="sort-btn" th:classappend="${sort == 'priceLow'} ? 'active'">ë‹¨ê°€ ë‚®ì€ìˆœ</button>
                </div>
            </div>
        </form>

        <div class="list-header-row" style="margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 10px;">
            <div class="total-count">
                ì´ <b th:text="${paging.totalElements}">0</b> ê±´
            </div>
        </div>

        <table class="market-table">
            <thead>
            <tr>
                <th class="col-no">No.</th>
                <th class="col-title">ë§¤ë¬¼ëª…</th>
                <th class="col-volume">ì „ë ¥ëŸ‰</th>
                <th class="col-price">íŒë§¤ë‹¨ê°€</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item, loop : ${paging}" th:onclick="|location.href='@{/market/post/{id}(id=${item.id})}'|">
                <td class="col-no" th:text="${paging.totalElements - (paging.number * paging.size) - loop.index}">22</td>
                <td class="col-title">
                    <div class="title-top">
                        <span class="badge-status-end" th:unless="${item.status == 'íŒë§¤ì¤‘'}" th:text="${item.status}">íŒë§¤ì¢…ë£Œ</span>
                        <span class="badge-energy" th:text="${item.energyType}">íƒœì–‘ê´‘</span>
                        <span class="region-text" th:text="'[' + ${#strings.arraySplit(item.location, ' ')[0]} + ']'">[ì œì£¼]</span>
                        <span class="title-text" th:text="${item.title}">ì œëª©</span>
                    </div>
                    <div class="badge-row" th:if="${item.contractType != null}">
                        <span class="badge-contract" th:each="type : ${#strings.arraySplit(item.contractType, ',')}" th:text="${type.trim()}">RECí˜„ë¬¼</span>
                    </div>
                </td>
                <td class="col-volume" th:if="${item.volumeKwh != null}">
                    <span th:if="${item.volumeKwh >= 1000000}" th:text="${#numbers.formatDecimal(item.volumeKwh / 1000000.0, 1, 1)} + ' GWh'"></span>
                    <span th:if="${item.volumeKwh >= 1000 and item.volumeKwh < 1000000}" th:text="${#numbers.formatDecimal(item.volumeKwh / 1000.0, 1, 1)} + ' MWh'"></span>
                    <span th:if="${item.volumeKwh < 1000}" th:text="${#numbers.formatInteger(item.volumeKwh, 0, 'COMMA')} + ' kWh'"></span>
                </td>
                <td class="col-volume" th:unless="${item.volumeKwh != null}">-</td>
                <td class="col-price">
                    <span th:if="${item.priceKrw != null}" th:text="${#numbers.formatInteger(item.priceKrw, 0, 'COMMA')} + ' ì›/kWh'"></span>
                    <span th:unless="${item.priceKrw != null}" style="color: #999; font-weight: normal;">ê°€ê²©í˜‘ì˜</span>
                </td>
            </tr>
            <tr th:if="${paging.isEmpty()}">
                <td colspan="4" style="text-align: center; padding: 50px; color: #888;">ê²€ìƒ‰ëœ ë§¤ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            </tbody>
        </table>

        <div class="pagination" th:if="${!paging.isEmpty()}">
            <a class="page-link" href="javascript:void(0)" onclick="movePage(0)" th:classappend="${paging.first} ? 'disabled'">&lt;&lt;</a>
            <a class="page-link" href="javascript:void(0)" th:onclick="|movePage(${paging.number - 1})|" th:classappend="${paging.first} ? 'disabled'">&lt;</a>

            <th:block th:with="start=${(paging.number/10)*10}, end=${(paging.totalPages == 0) ? 0 : ( (paging.totalPages - 1) < (start + 9) ? (paging.totalPages - 1) : (start + 9) )}">
                <th:block th:each="page: ${#numbers.sequence(start, end)}">
                    <a class="page-link" href="javascript:void(0)"
                       th:onclick="|movePage(${page})|"
                       th:text="${page + 1}"
                       th:classappend="${page == paging.number} ? 'active'">1</a>
                </th:block>
            </th:block>

            <a class="page-link" href="javascript:void(0)" th:onclick="|movePage(${paging.number + 1})|" th:classappend="${paging.last} ? 'disabled'">&gt;</a>
            <a class="page-link" href="javascript:void(0)" th:onclick="|movePage(${paging.totalPages - 1})|" th:classappend="${paging.last} ? 'disabled'">&gt;&gt;</a>
        </div>

    </main>
</div>

<script>
    // í•„í„° í† ê¸€ ê¸°ëŠ¥
    function toggleFilter() {
        const box = document.getElementById('filterBox');
        const icon = document.getElementById('toggleIcon');
        if (box.style.display === 'none' || box.style.display === '') {
            box.style.display = 'block';
            icon.innerText = 'â–²';
        } else {
            box.style.display = 'none';
            icon.innerText = 'â–¼';
        }
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    function resetFilter() {
        const inputs = document.querySelectorAll('#filterBox input');
        inputs.forEach(input => {
            if(input.type === 'checkbox') input.checked = false;
            else input.value = '';
        });
    }

    // ì •ë ¬ ë²„íŠ¼ í´ë¦­ ì‹œ
    function submitSort(sortVal) {
        document.querySelector('input[name="sort"]').value = sortVal;
        document.getElementById('pageInput').value = 0; // ì •ë ¬ ë°”ë€Œë©´ 1í˜ì´ì§€ë¡œ
        document.getElementById('searchForm').submit();
    }

    // í˜ì´ì§€ ì´ë™ ì‹œ
    function movePage(pageVal) {
        document.getElementById('pageInput').value = pageVal;
        document.getElementById('searchForm').submit();
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê²€ìƒ‰ ì¡°ê±´ì´ ìˆìœ¼ë©´ í•„í„°ì°½ ì—´ì–´ë‘ê¸°
    window.onload = function() {
        // (ê°„ë‹¨í•˜ê²Œ ì²´í¬ë°•ìŠ¤ê°€ í•˜ë‚˜ë¼ë„ ì²´í¬ë˜ì–´ ìˆê±°ë‚˜ ê°€ê²©ì´ ìˆìœ¼ë©´ ì—´ê¸°)
        const inputs = document.querySelectorAll('#filterBox input');
        let hasFilter = false;
        inputs.forEach(input => {
            if((input.type === 'checkbox' && input.checked) || (input.type === 'number' && input.value !== '')) {
                hasFilter = true;
            }
        });
        if(hasFilter) {
            toggleFilter();
        }
    }
</script>

</body>
</html>