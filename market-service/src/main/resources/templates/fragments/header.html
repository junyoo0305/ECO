<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<header th:fragment="header(activeMenu)" class="top-header">
    <a th:href="@{/seller/index}" class="logo">기업 재생에너지 지원센터</a>
    <nav>
        <ul>
            <li><a th:href="@{/market/marketpost}" th:classappend="${activeMenu == 'market'} ? 'active'">게시판 (거래소)</a></li>
            <li><a th:href="@{/seller/profile}" th:classappend="${activeMenu == 'profile'} ? 'active'">마이페이지</a></li>
        </ul>
    </nav>
    <div style="color: #94a3b8; font-size: 0.9rem;">
        <span id="header-user-id" style="font-weight: bold; color: #333;">게스트</span>님
        |
        <a href="javascript:void(0);" onclick="logout()" style="color: #cbd5e1; margin-left:10px;">로그아웃</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginUser();
        });

        // 1. 쿠키에서 토큰을 꺼내 ID를 표시하는 함수
        function checkLoginUser() {
            const token = getCookie('Authorization');
            if (token) {
                try {
                    // 'Bearer ' 제거
                    const actualToken = token.startsWith('Bearer ') ? token.slice(7) : token;

                    // JWT 디코딩 (Payload 추출)
                    const base64Url = actualToken.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));

                    const payload = JSON.parse(jsonPayload);

                    // ID 표시 (sub 클레임이 보통 ID입니다)
                    document.getElementById('header-user-id').textContent = payload.sub;
                } catch (e) {
                    console.error("토큰 파싱 실패", e);
                }
            }
        }

        // 2. 쿠키 가져오는 유틸 함수
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                // 인코딩된 쿠키 값을 디코딩해서 반환
                return decodeURIComponent(parts.pop().split(';').shift());
            }
            return null;
        }

        // 3. 로그아웃 함수
        function logout() {
            // 쿠키 삭제 (만료 시간을 과거로 설정)
            document.cookie = 'Authorization=; Path=/; Max-Age=0';

            alert('로그아웃 되었습니다.');
            // 메인 포트로 이동
            window.location.href = '/';
        }
    </script>
</header>
</body>
</html>